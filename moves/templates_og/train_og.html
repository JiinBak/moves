<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Accelerometer Javascript Test</title>
<meta name="viewport" content="width=device-width,user-scalable=yes" />
<style>
body {
	font-family: helvetica, arial, sans serif;
}

</style>
</head>

<body>
<div id="content">
    <h1>Model training</h1>




<input type="text" size="25" name="activity1">
<a href="javascript:void(0);" id="start_activity_1">Train activity #1</a>
<span id='activity_1_complete'></span>
<br>
<br>

<input type="text" size="25" name="activity2">
<a href="javascript:void(0);" id="start_activity_2">Train activity #2</a>
<span id='activity_2_complete'></span>
<br>
<br>


<input type="text" size="25" name="activity3">
<a href="javascript:void(0);" id="start_activity_3">Train activity #3</a>
<span id='activity_3_complete'></span>

<br>
<br>
<a href="javascript:void(0);" id="train_model">Build the model</a>
<span id='model_training_complete'></span>

<br>
<a href="" id="go_to_scoring">Proceed to model scoring</a>


</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script type="text/javascript" src="http://smoothiecharts.org/smoothie.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet">

<script type="text/javascript">

var x = 0 ,  y = 0,
    vx = 0, vy = 0,
	ax = 0, ay = 0;
	
if (window.DeviceMotionEvent != undefined) {
	window.ondevicemotion = function(e) {
		ax = event.accelerationIncludingGravity.x;
		ay = event.accelerationIncludingGravity.y;
		az = event.accelerationIncludingGravity.z
	}

    var socket = io.connect('http://' + document.domain + ':' + location.port);
    var accel_data = [];

    recordTime = 5*1000
    //create json output
    function event2json(label) {
        return {'data':true,
        'channel':1111111111,
        'data_type':'training',
        'timestamp':Date.now(),
        'label':label,
        'orientation':{'x':null,'y':null,'z':null},
        'motion':{'x':ax,'y':ay,'z':az}
        };
    };

    function logData(labelName,recordTime,elementID) { 
        var dataInterval = setInterval( function() {
        //accel_data.push(az)
        //accel_data.push(Math.random())
        ax = Math.random()
        ay = Math.random()
        az = Math.random()
        //console.log( event2json());
        
        accel_data.push(event2json(labelName))
        }, 67)

        captureJSON = {'channel':1111111111,
                       'data_type':'training',
                       'label':labelName};

        console.log(captureJSON)
        socket.emit('data_capture_phase',captureJSON);
        setTimeout(function() {
            clearInterval(dataInterval);
            captureJSON['data_type'] = null;
            captureJSON['label'] = null;
            socket.emit('data_capture_phase',captureJSON);
            document.getElementById(elementID).innerHTML = '&#9989;';
            }
        ,recordTime);
    };

    $('a#start_activity_1').bind('click', function() {
        var activityName = document.getElementsByName('activity1')[0].value
        logData(activityName,recordTime,'activity_1_complete');
    });

    $('a#start_activity_2').bind('click', function() {
        var activityName = document.getElementsByName('activity2')[0].value
        logData(activityName,recordTime,'activity_2_complete');
    });

    $('a#start_activity_3').bind('click', function() {
        var activityName = document.getElementsByName('activity3')[0].value
        logData(activityName,recordTime,'activity_3_complete');
    });

    $('a#train_model').bind('click', function() {
        socket.emit('training_data',{message :accel_data});
        socket.on('stored_training_data?', function(data){
            storedData = data.stored_data;
            var channel = data.channel;
            dataSuccesfullyStored = (storedData == true) & (channel = 1111111111);

            if (dataSuccesfullyStored) {
                trainRequestrUrl = 'http://move-train-bot.cfapps.pez.pivotal.io/train/' + channel
                //trainRequestrUrl = 'http://0.0.0.0:8081/train/' + channel
                // build the model
                $.get(trainRequestrUrl, function( data ) {
                    document.getElementById('model_training_complete').innerHTML = '&#9989;';
                });
                scoreUrl = 'score' + '/' + channel
                document.getElementById('go_to_scoring').setAttribute("href", scoreUrl);

            }
        });
        
    });
     
     
} 
</script>

</body>
</html>

